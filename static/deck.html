<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>PrismaController - Deck</title>

    <link href="/style/main.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>
    <script src="/scripts/utils.js"></script>
    <script src="/scripts/loadElements.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>
    <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
          integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
          referrerpolicy="no-referrer" rel="stylesheet"/>
</head>

<body onload="renderCommands()">

<div class="togglescreen left" id="fs-icon" onclick="toggleFS()"><i class="fas fa-expand-arrows-alt"></i></div>
<div class="togglescreen right" id="wake-lock"><i class="fas fa-lock-open"></i></div>
<div class="deck" id="deck">

</div>


<script>
    const elem = document.documentElement;

    const delayMap = new Map();

    function checkAuth() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('token')) {
            const auth = urlParams.get('token');
            return auth
        } else {
            return false
        }
    }
    let commands = {}
    function renderCommands() {
        let result = checkAuth()
        if (result) {
            const data = {"password": result};
            fetch('/commands/get', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(response => response.json())
                .then(data => {
                    commands = data
                    render(commands);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        } else {
            location.href = `./index.html`;
        }
    }

    function executeCommand(commandName) {
        let result = checkAuth()
        if (result) {
            const data = {"password": result, "command": commandName};
            fetch('/commands/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (!data.success) {
                        document.getElementById(commandName).style.boxShadow = "3px 3px 10px 1px #ED4245";
                    } else {
                        document.getElementById(commandName).style.boxShadow = "3px 3px 10px 1px #57F287";
                    }
                    delayMap.set(document.getElementById(commandName), new Date().getTime());
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        } else {
            location.href = `/index.html`;
        }
    }

    setInterval(() => {
        // iterate over all the keys in the delayMap
        for (let [key, value] of delayMap) {
            if ((new Date().getTime() - value) >= 1500) {
                key.style.boxShadow = "3px 3px 10px 1px #171b1f";
                delayMap.delete(key);
            }
        }
    }, 100)

</script>

<script>
    const noSleep = new NoSleep();
    let wakeLockEnabled = false;
    const toggleEl = document.querySelector("#wake-lock");
    toggleEl.addEventListener('click', function () {
        if (!wakeLockEnabled) {
            noSleep.enable(); // keep the screen on!
            wakeLockEnabled = true;
            document.querySelector("#wake-lock").innerHTML = '<i class="fas fa-lock"></i>';
        } else {
            noSleep.disable(); // let the screen turn off.
            wakeLockEnabled = false;
            document.querySelector("#wake-lock").innerHTML = '<i class="fas fa-lock-open"></i>';
        }
    }, false);
</script>
</body>

</html>
